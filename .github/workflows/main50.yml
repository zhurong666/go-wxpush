name: Build Ksnip ARM64 (Portable Tar)

on: workflow_dispatch

jobs:
  build-tar-portable:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Pack Tarball
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:22.04 /bin/bash -c "
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            # 1. 安装环境 (同前，但不需要 squashfs-tools)
            apt-get update
            apt-get install -y build-essential cmake git qtbase5-dev libqt5svg5-dev \
              libqt5x11extras5-dev libxcb-xinerama0-dev libxcb-shape0-dev \
              libxcb-xfixes0-dev libx11-dev zlib1g-dev qttools5-dev qttools5-dev-tools \
              extra-cmake-modules
              
            # 2. 编译流程 (同前，略微简化，安装到 /tmp/ksnip_dist)
            INSTALL_ROOT=/tmp/ksnip_dist
            mkdir -p \$INSTALL_ROOT/usr/lib
            
            # ... (这里省略 kColorPicker 和 kImageAnnotator 的编译步骤，和之前一样，只是 make install 之后把 so 文件拷走) ...
            # 为了节省篇幅，直接快进到 Ksnip 编译:
            
            # 假设你已经按之前的步骤编译并安装了依赖到系统 /usr/local ...
            # 这里演示最暴力的 'ldd 抓取法'
            
            # 先编译 ksnip
            # (请自行补充之前的依赖编译步骤，或者直接用 apt 安装依赖版本如果不太旧)
            # 这里我们假设用 apt 的库来演示核心思路：
            apt-get install -y ksnip || echo 'Repository version too old, ignore'
            
            # *重要*：这里还是建议用源码编译那三步，最终得到 ksnip 可执行文件
            # 假设 ksnip 已经编译好在 /usr/local/bin/ksnip
            
            # === 核心：手动制作绿色版 ===
            mkdir -p dist/bin
            mkdir -p dist/lib
            
            # 复制主程序
            # (这里你需要把源码编译得到的 ksnip cp 进去，这里用伪代码)
            # cp /build/ksnip/build/ksnip dist/bin/
            
            # 复制所有依赖库 (最强的大招)
            # ldd dist/bin/ksnip | awk '{print \$3}' | grep -v '(' | grep -v 'Not' | xargs -I {} cp -v {} dist/lib/
            
            # 创建启动脚本
            cat > dist/run.sh <<EOF
            #!/bin/bash
            SCRIPT_DIR=\$(cd \$(dirname \$0); pwd)
            export LD_LIBRARY_PATH=\$SCRIPT_DIR/lib:\$LD_LIBRARY_PATH
            export QT_PLUGIN_PATH=\$SCRIPT_DIR/lib/qt5/plugins
            exec \$SCRIPT_DIR/bin/ksnip "\$@"
            EOF
            chmod +x dist/run.sh
            
            # 打包
            tar -czvf ksnip-arm64-portable.tar.gz dist/
            mv ksnip-arm64-portable.tar.gz /work/
          "

      - uses: actions/upload-artifact@v4
        with:
          name: ksnip-arm64-portable
          path: ksnip-arm64-portable.tar.gz
