name: Build SSR ARM64 (Final Fix)

on: workflow_dispatch

jobs:
  build-ssr-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Package
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:20.04 /bin/bash -c "
            
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo '>>> [1/5] å®‰è£…ä¾èµ–...'
            apt-get update
            # åŸºç¡€ç¼–è¯‘å·¥å…· + Qt5 + éŸ³è§†é¢‘åº“ + V4L2
            apt-get install -y build-essential cmake git wget file \
                qt5-default qttools5-dev-tools libqt5x11extras5-dev \
                libavformat-dev libavcodec-dev libavutil-dev libswscale-dev \
                libasound2-dev libpulse-dev libjack-dev \
                libx11-dev libxext-dev libxfixes-dev libxi-dev \
                libgl1-mesa-dev libglu1-mesa-dev \
                libv4l-dev \
                squashfs-tools

            echo '>>> [2/5] ç¼–è¯‘ SimpleScreenRecorder...'
            cd /work
            git clone https://github.com/MaartenBaert/ssr.git
            cd ssr
            mkdir build && cd build
            
            # ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼š
            # -DWITH_PIPEWIRE=OFF: å…³é—­ PipeWire (è§£å†³ Ubuntu 20.04 æ‰¾ä¸åˆ°ä¾èµ–çš„é—®é¢˜)
            # -DWITH_GLINJECT=OFF: å…³é—­ GL æ³¨å…¥ (å‡å°‘ä¾èµ–ï¼Œæé«˜ä¾¿æºæ€§)
            cmake .. \
                -DCMAKE_INSTALL_PREFIX=/AppDir/usr \
                -DCMAKE_BUILD_TYPE=Release \
                -DWITH_GLINJECT=OFF \
                -DWITH_PIPEWIRE=OFF \
                -DWITH_QT5=ON
                
            make -j\$(nproc)
            make install

            echo '>>> [3/5] å‡†å¤‡æ‰“åŒ…å·¥å…·...'
            cd /work
            # ä½¿ç”¨ continuous ç‰ˆæœ¬ä¸‹è½½ linuxdeploy
            wget -c https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
            wget -c https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-aarch64.AppImage
            
            chmod +x linuxdeploy*.AppImage
            
            # è§£å‹å·¥å…· (ç»•è¿‡ Docker FUSE é™åˆ¶)
            sed -i 's|AI\x02|\x00\x00\x00|' linuxdeploy-aarch64.AppImage
            ./linuxdeploy-aarch64.AppImage --appimage-extract
            mv squashfs-root linuxdeploy-root

            sed -i 's|AI\x02|\x00\x00\x00|' linuxdeploy-plugin-qt-aarch64.AppImage
            ./linuxdeploy-plugin-qt-aarch64.AppImage --appimage-extract
            mv squashfs-root linuxdeploy-qt-plugin

            echo '>>> [4/5] ç”Ÿæˆ AppImage...'
            export QT_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/qt5/plugins/
            export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib
            
            # æ™ºèƒ½æŸ¥æ‰¾ desktop å’Œ icon æ–‡ä»¶
            DESKTOP_FILE=\$(find /AppDir -name \"simplescreenrecorder.desktop\")
            ICON_FILE=\$(find /AppDir -name \"simplescreenrecorder.png\" | grep 256 | head -n 1)

            # é…ç½®æ’ä»¶è·¯å¾„
            mv linuxdeploy-qt-plugin/AppRun /usr/bin/linuxdeploy-plugin-qt
            
            # å¼€å§‹æ‰“åŒ…
            ./linuxdeploy-root/AppRun \
                --appdir /AppDir \
                --desktop-file \$DESKTOP_FILE \
                --icon-file \$ICON_FILE \
                --plugin qt \
                --output appimage
            
            # é‡å‘½åå¹¶æ¸…ç†
            mv SimpleScreenRecorder-*.AppImage SSR-ARM64.AppImage
            echo 'âœ… æ„å»ºæˆåŠŸï¼'
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SSR-ARM64-Portable
          path: SSR-ARM64.AppImage
