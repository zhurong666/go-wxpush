name: Build SSR ARM64 (AppImage) - Fixed

on: workflow_dispatch

jobs:
  build-ssr-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Package
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:20.04 /bin/bash -c "
            
            set -e
            export DEBIAN_FRONTEND=noninteractive
            export INSTALL_PREFIX=/usr
            
            echo '>>> [1/5] å®‰è£…ä¾èµ– (ä¿®å¤ç¼ºå°‘ V4L2 çš„é—®é¢˜)...'
            apt-get update
            # ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ·»åŠ äº† libv4l-dev
            apt-get install -y build-essential cmake git wget file \
                qt5-default qttools5-dev-tools libqt5x11extras5-dev \
                libavformat-dev libavcodec-dev libavutil-dev libswscale-dev \
                libasound2-dev libpulse-dev libjack-dev \
                libx11-dev libxext-dev libxfixes-dev libxi-dev \
                libgl1-mesa-dev libglu1-mesa-dev \
                libv4l-dev \
                squashfs-tools

            echo '>>> [2/5] ç¼–è¯‘ SimpleScreenRecorder...'
            cd /work
            git clone https://github.com/MaartenBaert/ssr.git
            cd ssr
            mkdir build && cd build
            
            # å…³é—­ GLæ³¨å…¥åº“ (ä¾¿æºç‰ˆä¸éœ€è¦æ³¨å…¥åŠŸèƒ½ï¼Œä¸”å®¹æ˜“å¯¼è‡´å…¼å®¹æ€§é—®é¢˜)
            cmake .. \
                -DCMAKE_INSTALL_PREFIX=/AppDir/usr \
                -DCMAKE_BUILD_TYPE=Release \
                -DWITH_GLINJECT=OFF \
                -DWITH_QT5=ON
                
            make -j\$(nproc)
            make install

            echo '>>> [3/5] å‡†å¤‡æ‰“åŒ…å·¥å…·...'
            cd /work
            # è¿™é‡Œçš„ URL ä½¿ç”¨ continuous ç‰ˆæœ¬ï¼Œå¦‚æœä¸‹è½½å¤±è´¥å¯ä»¥æ¢å›ºå®šç‰ˆæœ¬
            wget -c https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
            wget -c https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-aarch64.AppImage
            
            chmod +x linuxdeploy*.AppImage
            
            # æå– AppImage å†…å®¹ä»¥ç»•è¿‡ Docker FUSE é™åˆ¶
            sed -i 's|AI\x02|\x00\x00\x00|' linuxdeploy-aarch64.AppImage
            ./linuxdeploy-aarch64.AppImage --appimage-extract
            mv squashfs-root linuxdeploy-root

            sed -i 's|AI\x02|\x00\x00\x00|' linuxdeploy-plugin-qt-aarch64.AppImage
            ./linuxdeploy-plugin-qt-aarch64.AppImage --appimage-extract
            mv squashfs-root linuxdeploy-qt-plugin

            echo '>>> [4/5] ç”Ÿæˆ AppImage...'
            export QT_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/qt5/plugins/
            export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib
            
            # æ‰‹åŠ¨æŒ‡å®š desktop å’Œ icon è·¯å¾„ï¼Œç¡®ä¿æ‰“åŒ…å·¥å…·èƒ½æ‰¾åˆ°
            DESKTOP_FILE=\$(find /AppDir -name \"simplescreenrecorder.desktop\")
            ICON_FILE=\$(find /AppDir -name \"simplescreenrecorder.png\" | grep 256 | head -n 1)

            # ä¸ºäº†è®© linuxdeploy æ‰¾åˆ°æ’ä»¶ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®æ’ä»¶è·¯å¾„
            # è¿™é‡Œæˆ‘ä»¬ç›´æ¥æ‰‹åŠ¨è°ƒç”¨ Qt æ’ä»¶çš„é€»è¾‘å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬æ”¹ç”¨ç¯å¢ƒå˜é‡æ–¹å¼
            # æˆ–è€…æ›´ç®€å•çš„ï¼šç›´æ¥ç”¨ --plugin qt å‚æ•°ï¼Œå‰ææ˜¯ linuxdeploy èƒ½åœ¨ PATH é‡Œæ‰¾åˆ°æ’ä»¶
            # æˆ‘ä»¬æŠŠæ’ä»¶ç§»åŠ¨åˆ° PATH è·¯å¾„ä¸‹
            mv linuxdeploy-qt-plugin/AppRun /usr/bin/linuxdeploy-plugin-qt
            
            ./linuxdeploy-root/AppRun \
                --appdir /AppDir \
                --desktop-file \$DESKTOP_FILE \
                --icon-file \$ICON_FILE \
                --plugin qt \
                --output appimage
            
            mv SimpleScreenRecorder-*.AppImage SSR-ARM64.AppImage
            echo '>>> æ„å»ºæˆåŠŸï¼'
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SSR-ARM64-Portable
          path: SSR-ARM64.AppImage
