name: Build SSR ARM64 (Final Fix v2)

on: workflow_dispatch

jobs:
  build-ssr-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Package
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:20.04 /bin/bash -c "
            
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo '>>> [1/5] 安装依赖...'
            apt-get update
            # 补全了 libxinerama-dev 和 qttools5-dev
            apt-get install -y build-essential cmake git wget file \
                qt5-default qttools5-dev-tools qttools5-dev libqt5x11extras5-dev \
                libavformat-dev libavcodec-dev libavutil-dev libswscale-dev \
                libasound2-dev libpulse-dev libjack-dev \
                libx11-dev libxext-dev libxfixes-dev libxi-dev libxinerama-dev \
                libgl1-mesa-dev libglu1-mesa-dev \
                libv4l-dev \
                squashfs-tools

            echo '>>> [2/5] 编译 SimpleScreenRecorder...'
            cd /work
            git clone https://github.com/MaartenBaert/ssr.git
            cd ssr
            mkdir build && cd build
            
            # -DWITH_PIPEWIRE=OFF: 关闭 PipeWire
            # -DWITH_GLINJECT=OFF: 关闭 GL 注入
            cmake .. \
                -DCMAKE_INSTALL_PREFIX=/AppDir/usr \
                -DCMAKE_BUILD_TYPE=Release \
                -DWITH_GLINJECT=OFF \
                -DWITH_PIPEWIRE=OFF \
                -DWITH_QT5=ON
                
            make -j\$(nproc)
            make install

            echo '>>> [3/5] 准备打包工具...'
            cd /work
            wget -c
