name: Build SSR ARM64 (AppImage)

on: workflow_dispatch

jobs:
  build-ssr-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Package
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:20.04 /bin/bash -c "
            
            # === 1. 环境准备 (Ubuntu 20.04) ===
            set -e
            export DEBIAN_FRONTEND=noninteractive
            export INSTALL_PREFIX=/usr
            
            echo '>>> [1/5] 安装依赖...'
            apt-get update
            # 安装 SSR 编译所需的 Qt5 和音视频库
            apt-get install -y build-essential cmake git wget file \
                qt5-default qttools5-dev-tools libqt5x11extras5-dev \
                libavformat-dev libavcodec-dev libavutil-dev libswscale-dev \
                libasound2-dev libpulse-dev libjack-dev \
                libx11-dev libxext-dev libxfixes-dev libxi-dev \
                libgl1-mesa-dev libglu1-mesa-dev
            
            # 安装 squashfs-tools 用于打包 AppImage
            apt-get install -y squashfs-tools

            # === 2. 编译 SimpleScreenRecorder ===
            echo '>>> [2/5] 编译 SimpleScreenRecorder...'
            cd /work
            git clone https://github.com/MaartenBaert/ssr.git
            cd ssr
            mkdir build && cd build
            
            # 编译并安装到 /AppDir (临时目录)
            # -DWITH_GLINJECT=OFF: 关闭 OpenGL 注入库(便携版带着个麻烦，且你主要录桌面)
            cmake .. \
                -DCMAKE_INSTALL_PREFIX=/AppDir/usr \
                -DCMAKE_BUILD_TYPE=Release \
                -DWITH_GLINJECT=OFF \
                -DWITH_QT5=ON
                
            make -j\$(nproc)
            make install

            # === 3. 准备打包工具 linuxdeploy ===
            echo '>>> [3/5] 准备打包工具...'
            cd /work
            wget -nv https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
            wget -nv https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-aarch64.AppImage
            
            chmod +x linuxdeploy*.AppImage
            
            # 解压 linuxdeploy (绕过 Docker 内 FUSE 限制)
            sed -i 's|AI\x02|\x00\x00\x00|' linuxdeploy-aarch64.AppImage
            ./linuxdeploy-aarch64.AppImage --appimage-extract
            mv squashfs-root linuxdeploy-root

            # 解压 Qt 插件
            sed -i 's|AI\x02|\x00\x00\x00|' linuxdeploy-plugin-qt-aarch64.AppImage
            ./linuxdeploy-plugin-qt-aarch64.AppImage --appimage-extract
            mv squashfs-root linuxdeploy-qt-plugin

            # === 4. 打包 AppImage ===
            echo '>>> [4/5] 生成 AppImage...'
            
            # 设置环境变量帮助工具找到 Qt 库
            export QT_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/qt5/plugins/
            export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib
            
            # 找到 desktop 文件和图标
            DESKTOP_FILE=/AppDir/usr/share/applications/simplescreenrecorder.desktop
            ICON_FILE=/AppDir/usr/share/icons/hicolor/256x256/apps/simplescreenrecorder.png

            # 运行打包
            # --plugin qt: 自动把 Qt5 的库塞进去，解决依赖问题
            ./linuxdeploy-root/AppRun \
                --appdir /AppDir \
                --desktop-file \$DESKTOP_FILE \
                --icon-file \$ICON_FILE \
                --plugin qt \
                --output appimage
            
            # 重命名产物
            mv SimpleScreenRecorder-*.AppImage SSR-ARM64.AppImage
            
            echo '>>> 构建成功！'
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SSR-ARM64-Portable
          path: SSR-ARM64.AppImage
