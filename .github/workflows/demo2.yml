name: Build SSR ARM64 (Final Fix v3)

on: workflow_dispatch

jobs:
  build-ssr-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Package
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:20.04 /bin/bash -c "
            
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo '>>> [1/5] 安装依赖...'
            apt-get update
            apt-get install -y build-essential cmake git wget file \
                qt5-default qttools5-dev-tools qttools5-dev libqt5x11extras5-dev \
                libavformat-dev libavcodec-dev libavutil-dev libswscale-dev \
                libasound2-dev libpulse-dev libjack-dev \
                libx11-dev libxext-dev libxfixes-dev libxi-dev libxinerama-dev \
                libgl1-mesa-dev libglu1-mesa-dev \
                libv4l-dev \
                squashfs-tools

            echo '>>> [2/5] 编译 SimpleScreenRecorder...'
            cd /work
            git clone https://github.com/MaartenBaert/ssr.git
            cd ssr
            mkdir build && cd build
            
            cmake .. \
                -DCMAKE_INSTALL_PREFIX=/AppDir/usr \
                -DCMAKE_BUILD_TYPE=Release \
                -DWITH_GLINJECT=OFF \
                -DWITH_PIPEWIRE=OFF \
                -DWITH_QT5=ON
                
            make -j\$(nproc)
            make install

            echo '>>> [3/5] 准备打包工具...'
            cd /work
            wget -c https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
            wget -c https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-aarch64.AppImage
            
            chmod +x linuxdeploy*.AppImage
            
            # === 核心修复：防止解压冲突 ===
            
            # 1. 解压主程序
            sed -i 's|AI\x02|\x00\x00\x00|' linuxdeploy-aarch64.AppImage
            ./linuxdeploy-aarch64.AppImage --appimage-extract
            # 立刻重命名，防止下次解压覆盖报错
            rm -rf linuxdeploy-root  # 清理旧的(如果有)
            mv squashfs-root linuxdeploy-root

            # 2. 解压 Qt 插件
            sed -i 's|AI\x02|\x00\x00\x00|' linuxdeploy-plugin-qt-aarch64.AppImage
            ./linuxdeploy-plugin-qt-aarch64.AppImage --appimage-extract
            # 立刻重命名
            rm -rf linuxdeploy-qt-plugin # 清理旧的(如果有)
            mv squashfs-root linuxdeploy-qt-plugin

            echo '>>> [4/5] 生成 AppImage...'
            export QT_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/qt5/plugins/
            export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib
            
            DESKTOP_FILE=\$(find /AppDir -name \"simplescreenrecorder.desktop\")
            ICON_FILE=\$(find /AppDir -name \"simplescreenrecorder.png\" | grep 256 | head -n 1)

            # 移动插件到系统路径方便调用
            mv linuxdeploy-qt-plugin/AppRun /usr/bin/linuxdeploy-plugin-qt
            
            ./linuxdeploy-root/AppRun \
                --appdir /AppDir \
                --desktop-file \$DESKTOP_FILE \
                --icon-file \$ICON_FILE \
                --plugin qt \
                --output appimage
            
            mv SimpleScreenRecorder-*.AppImage SSR-ARM64.AppImage
            echo '✅ 构建成功！'
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SSR-ARM64-Portable
          path: SSR-ARM64.AppImage
