name: Download Fix-Font Packages (Smart Dependency)

on: workflow_dispatch

jobs:
  download-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Download Packages via Docker
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          condaforge/miniforge3:latest /bin/bash -c "
            
            set -e
            
            echo '=== [1] 准备环境 ==='
            mkdir -p /work/offline_pkgs
            export CONDA_PKGS_DIRS=/work/offline_pkgs
            
            conda config --add channels conda-forge
            conda config --set channel_priority strict
            
            echo '=== [2] 下载最新版依赖 (Correct Version Spec) ==='
            
            # 关键修正点：
            # 1. 不要写 tcl=8.6 (这会导致找不到包)
            # 2. 写 tcl=8.6.* (这表示 8.6 系列的任意版本，它会找到 8.6.13)
            # 3. 同样的，tk=8.6.*
            
            conda create -n download_env \
                python=3.11 \
                'tk=8.6.*' \
                'tcl=8.6.*' \
                xorg-libxft \
                cairo \
                pango \
                pyinstaller \
                --download-only \
                --yes
            
            echo '=== [3] 验证版本 ==='
            cd /work/offline_pkgs
            echo '下载到的 Tk 版本：'
            ls tk-*.conda tk-*.tar.bz2 || echo 'Tk missing'
            
            echo '下载到的 Tcl 版本：'
            ls tcl-*.conda tcl-*.tar.bz2 || echo 'Tcl missing'
            
            # 这里的检查确保我们要的是 8.6.1x (比如 8.6.13)，而不是老的 8.6.9
            if ls tk-8.6.1* > /dev/null 2>&1; then
                echo '✅ 完美：下载到了现代版本的 Tk (8.6.10+)'
            else
                echo '⚠️ 警告：下载的版本可能过旧，请检查日志'
            fi

            echo '=== [4] 打包 ==='
            rm -rf *.lock urls.txt *.json info/
            
            # 生成简单的安装脚本
            echo '#!/bin/bash' > install.sh
            echo 'conda install --offline --no-deps *.conda *.tar.bz2' >> install.sh
            chmod +x install.sh
            
            cd /work
            tar -czvf fix-font-packages-correct-v2.tar.gz offline_pkgs/
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fix-font-packages-correct-v2
          path: fix-font-packages-correct-v2.tar.gz

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fix-font-pkgs-auto
          path: fix-font-pkgs-auto.tar.gz
