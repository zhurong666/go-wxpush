name: Build Custom Miniconda (Uncastrated Tk)

on: workflow_dispatch

jobs:
  build-installer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build Installer via Docker
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          condaforge/miniforge3:latest /bin/bash -c "
            
            set -e
            echo '=== [1] 准备构建环境 ==='
            # constructor 是用来制造安装包的工具
            conda install -n base -c conda-forge constructor --yes
            
            mkdir -p /work/build_dir
            cd /work/build_dir
            
            echo '=== [2] 定义 construct.yaml (构建蓝图) ==='
            # 这是最关键的一步：我们在这里定义“完美环境”包含什么
            
            cat <<EOF > construct.yaml
            name: FixFontConda
            version: 1.0.0
            
            # 使用 conda-forge 频道，包最全
            channels:
              - conda-forge
            
            # 这是一个 ARM64 的安装包
            specs:
              - python=3.11
              # 关键：指定版本范围，不要写死 8.6
              - tk=8.6.*
              - tcl=8.6.*
              # 关键：显式加入 Xft 和 Cairo，逼迫 conda 选择支持 GUI 的 Tk 版本
              - xorg-libxft
              - cairo
              - pango
              # 你需要的其他包
              - pyinstaller
              # 基础工具
              - pip
              - wheel
            
            # 安装器设置
            installer_filename: FixFontConda-Linux-aarch64.sh
            EOF
            
            echo '=== [3] 开始构建安装包 ==='
            # constructor 会自动下载 ARM64 的包并打包成 .sh
            constructor .
            
            echo '=== [4] 移动产物 ==='
            mv FixFontConda-Linux-aarch64.sh /work/
          "

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: FixFontConda-Installer
          path: FixFontConda-Linux-aarch64.sh
