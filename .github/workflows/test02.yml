name: Download Fix-Font Packages (Strict Hash Match)

on: workflow_dispatch

jobs:
  download-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Download Packages via Docker
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          condaforge/miniforge3:latest /bin/bash -c "
            
            set -x
            set -e
            
            echo '=== [1] 环境初始化 ==='
            mkdir -p /work/offline_pkgs
            export CONDA_PKGS_DIRS=/work/offline_pkgs
            conda clean --all --yes
            
            conda config --add channels conda-forge
            conda config --set channel_priority strict
            
            echo '=== [2] 下载包 (精确打击) ==='
            
            # 核心修改：
            # tk=8.6.*=h* # 解释：
            # 1. 版本必须是 8.6.x
            # 2. Build String (文件名下划线后的部分) 必须以 'h' 开头
            # 结果：
            # ✅ 命中 tk-8.6.13-h194ca79_0.conda (以 h 开头)
            # ❌ 排除 tk-8.6.13-noxft_... (以 n 开头)
            
            conda create -n download_env \
                python=3.11 \
                'tk=8.6.*=h*' \
                xorg-libxft \
                cairo \
                pango \
                pyinstaller \
                --download-only \
                --yes
            
            echo '=== [3] 最终核验 (Final Verification) ==='
            cd /work/offline_pkgs
            
            # 检查是否下载到了正确的包
            if ls tk-*.conda | grep -q 'noxft'; then
                echo '❌ 严重失败：依然下载到了 noxft 包！'
                ls -lh tk-*
                exit 1
            else
                echo '✅ 验证通过：没有 noxft 包。'
            fi
            
            # 打印下载到的 Tk 详细信息，让你放心
            echo '-> 捕获到的 Tk 包：'
            ls -lh tk-*.conda
            
            echo '=== [4] 打包 ==='
            rm -rf *.lock urls.txt *.json info/
            
            echo '#!/bin/bash' > install.sh
            echo 'echo \"=== 开始安装 (Verified GUI Version) ===\"' >> install.sh
            echo 'conda install --offline --no-deps --force-reinstall *.conda *.tar.bz2' >> install.sh
            chmod +x install.sh
            
            cd /work
            tar -czvf fix-font-packages-verified-arm64.tar.gz offline_pkgs/
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fix-font-packages-verified-arm64
          path: fix-font-packages-verified-arm64.tar.gz