name: Build Custom Miniconda (Uncastrated Tk)

on: workflow_dispatch

jobs:
  build-installer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build Installer via Docker
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          condaforge/miniforge3:latest /bin/bash -c "
            
            set -e
            echo '=== [1] 准备构建环境 ==='
            # 安装构建工具 constructor
            conda install -n base -c conda-forge constructor --yes
            
            mkdir -p /work/build_dir
            cd /work/build_dir
            
            echo '=== [2] 定义 construct.yaml (Echo Mode) ==='
            
            # 使用 echo 逐行写入，彻底避免 EOF 解析错误
            # 注意：YAML 对缩进敏感，echo 里的空格必须保留
            
            echo 'name: FixFontConda' > construct.yaml
            echo 'version: 1.0.0' >> construct.yaml
            
            echo 'channels:' >> construct.yaml
            echo '  - conda-forge' >> construct.yaml
            
            echo 'specs:' >> construct.yaml
            echo '  - python=3.11' >> construct.yaml
            
            # 强制指定 Tk/Tcl 版本范围 (自动匹配最新的 8.6.13)
            echo '  - tk=8.6.*' >> construct.yaml
            echo '  - tcl=8.6.*' >> construct.yaml
            
            # 关键：显式加入图形库，防止被阉割
            echo '  - xorg-libxft' >> construct.yaml
            echo '  - cairo' >> construct.yaml
            echo '  - pango' >> construct.yaml
            
            # 工具包
            echo '  - pyinstaller' >> construct.yaml
            echo '  - pip' >> construct.yaml
            echo '  - wheel' >> construct.yaml
            
            echo 'installer_filename: FixFontConda-Linux-aarch64.sh' >> construct.yaml
            
            echo '=== [3] 检查 YAML 内容 (Debug) ==='
            cat construct.yaml
            
            echo '=== [4] 开始构建安装包 ==='
            constructor .
            
            echo '=== [5] 移动产物 ==='
            mv FixFontConda-Linux-aarch64.sh /work/
          "

      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: FixFontConda-Installer
          path: FixFontConda-Linux-aarch64.sh