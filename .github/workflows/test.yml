name: Download Fix-Font Packages (Final Stable)

on: workflow_dispatch

jobs:
  download-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Download Packages & System Libs
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          condaforge/miniforge3:latest /bin/bash -c "
            
            set -x
            set -e
            
            echo '=== [0] 工具准备 ==='
            # 安装解压工具
            conda install -n base binutils curl --yes

            echo '=== [1] 环境初始化 ==='
            mkdir -p /work/offline_pkgs
            export CONDA_PKGS_DIRS=/work/offline_pkgs
            conda clean --all --yes
            conda config --add channels conda-forge
            conda config --set channel_priority strict
            
            echo '=== [2] 下载常规 Conda 包 ==='
            conda create -n download_env \
                python=3.11 \
                tk=8.6 \
                xorg-libxft cairo pango \
                --download-only --yes
            
            echo '=== [2.5] ★关键步骤★：下载 Ubuntu 18.04 系统级 Tk 库 (最强兼容版) ==='
            mkdir -p /work/system_libs
            cd /work/system_libs
            
            # 使用 Ubuntu Ports (Bionic) 源，确保 glibc 版本够低，兼容 UOS 20
            # Tk 8.6.8 与 8.6.x 系列 ABI 完全兼容
            
            echo 'Downloading libtk8.6...'
            curl -L -o libtk8.6.deb http://ports.ubuntu.com/pool/main/t/tk8.6/libtk8.6_8.6.8-4_arm64.deb
            
            echo 'Downloading libtcl8.6...'
            curl -L -o libtcl8.6.deb http://ports.ubuntu.com/pool/main/t/tcl8.6/libtcl8.6_8.6.8-4_arm64.deb
            
            # 检查文件大小，确保不是 300 字节的 404 网页
            ls -lh *.deb
            
            # 解压 deb 包
            ar x libtk8.6.deb data.tar.xz
            tar -xf data.tar.xz
            # 移动并重命名 (Ubuntu 的命名规则通常是 libtk8.6.so.0)
            mv usr/lib/aarch64-linux-gnu/libtk8.6.so.0 ./libtk8.6.so
            rm data.tar.xz
            
            ar x libtcl8.6.deb data.tar.xz
            tar -xf data.tar.xz
            mv usr/lib/aarch64-linux-gnu/libtcl8.6.so.0 ./libtcl8.6.so
            
            echo '✅ 成功提取系统级 libtk8.6.so'
            ls -lh *.so
            
            echo '=== [4] 打包与生成安装脚本 ==='
            cd /work
            rm -rf *.lock urls.txt *.json info/
            
            # 注意：下面的 EOF 块内，双引号 \" 必须转义，变量 \$ 必须转义
            cat > install.sh << 'EOF'
            #!/bin/bash
            echo \"=== 1. 安装 Conda 包 ===\"
            conda install --offline --no-deps --force-reinstall offline_pkgs/*.conda offline_pkgs/*.tar.bz2
            
            echo \"=== 2. 执行器官移植 (替换为 Ubuntu 系统级 Tk 库) ===\"
            # 找到 conda 环境目录
            TARGET_LIB=\"\$CONDA_PREFIX/lib\"
            
            echo \"正在覆盖 libtk8.6.so ...\"
            cp -f system_libs/libtk8.6.so \$TARGET_LIB/libtk8.6.so
            cp -f system_libs/libtcl8.6.so \$TARGET_LIB/libtcl8.6.so
            
            # 建立软链接，防止程序找 .so.0
            ln -sf \$TARGET_LIB/libtk8.6.so \$TARGET_LIB/libtk8.6.so.0
            ln -sf \$TARGET_LIB/libtcl8.6.so \$TARGET_LIB/libtcl8.6.so.0
            
            echo \"=== 3. 注入系统字体配置 (治愈雪盲症) ===\"
            mkdir -p \$CONDA_PREFIX/etc/conda/activate.d
            mkdir -p \$CONDA_PREFIX/etc/conda/deactivate.d
            
            echo 'export FONTCONFIG_PATH=/etc/fonts' > \$CONDA_PREFIX/etc/conda/activate.d/fonts.sh
            echo 'unset FONTCONFIG_PATH' >> \$CONDA_PREFIX/etc/conda/deactivate.d/fonts.sh
            
            echo \"✅ 安装完成！请重新激活环境: conda deactivate && conda activate dev\"
            EOF
            
            chmod +x install.sh
            
            tar -czvf fix-font-final-arm64.tar.gz offline_pkgs/ system_libs/ install.sh
          "
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fix-font-final-arm64
          path: fix-font-final-arm64.tar.gz