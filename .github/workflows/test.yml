name: Download Fix-Font Packages (Corrected)

on: workflow_dispatch

jobs:
  download-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Download Packages via Docker
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          condaforge/miniforge3:latest /bin/bash -c "
            
            set -e
            
            echo '=== [1/4] 准备下载目录 ==='
            mkdir -p /work/offline_pkgs
            export CONDA_PKGS_DIRS=/work/offline_pkgs
            
            echo '=== [2/4] 配置下载环境 ==='
            conda config --add channels conda-forge
            conda config --set channel_priority strict
            
            echo '=== [3/4] 开始下载 (强制 Xft 版) ==='
            # 核心修改：
            # 1. 显式加入 tcl=8.6.* (确保 tcl 被下载)
            # 2. 加入 libxft 和 cairo (这是满血版 Tk 的必须依赖，加了它们，noxft 版就会被排除)
            # 3. 继续使用 python=3.11 (和你内网一致)
            
            conda create -n temp_env \
                python=3.11 \
                tk=8.6.* \
                tcl=8.6.* \
                libxft \
                cairo \
                pyinstaller \
                --download-only \
                --yes
            
            echo '=== [4/4] 清理与整理 ==='
            cd /work/offline_pkgs
            rm -rf *.lock urls.txt *.json info/
            
            echo '生成安装脚本...'
            
            # 生成 install_fix.sh (使用 echo 避免语法错误)
            echo '#!/bin/bash' > install_fix.sh
            echo 'echo \"=== 开始离线修复 (Xft增强版) ===\"' >> install_fix.sh
            
            # 1. 强制安装 tcl 和 tk (顺序很重要，先 tcl 后 tk)
            # 注意：这次我们会检查文件名，确保不安装 noxft 版本 (虽然下载时不应该有，但为了保险)
            echo 'echo \"-> 安装 Tcl...\"' >> install_fix.sh
            echo 'find . -maxdepth 1 -name \"tcl-*\" | xargs -I {} conda install --offline --no-deps --force-reinstall {}' >> install_fix.sh
            
            echo 'echo \"-> 安装 Tk (确保是 Xft 版本)...\"' >> install_fix.sh
            # 排除 noxft 的文件，防止误装
            echo 'find . -maxdepth 1 -name \"tk-*\" ! -name \"*noxft*\" | xargs -I {} conda install --offline --no-deps --force-reinstall {}' >> install_fix.sh
            
            # 2. 安装 Xft 依赖库 (libxft, cairo 等)
            echo 'echo \"-> 安装图形依赖库...\"' >> install_fix.sh
            echo 'find . -maxdepth 1 -name \"libxft-*\" -o -name \"cairo-*\" | xargs -I {} conda install --offline --no-deps --force-reinstall {}' >> install_fix.sh

            # 3. 安装剩余依赖
            echo 'echo \"-> 安装其他依赖...\"' >> install_fix.sh
            echo 'for pkg in *; do' >> install_fix.sh
            echo '    if [[ \"\$pkg\" == *.tar.bz2 ]] || [[ \"\$pkg\" == *.conda ]]; then' >> install_fix.sh
            echo '        if [[ \"\$pkg\" != tk-* ]] && [[ \"\$pkg\" != tcl-* ]] && [[ \"\$pkg\" != libxft-* ]] && [[ \"\$pkg\" != cairo-* ]]; then' >> install_fix.sh
            echo '            echo \"Installing \$pkg ...\"' >> install_fix.sh
            echo '            conda install --offline \"\$pkg\"' >> install_fix.sh
            echo '        fi' >> install_fix.sh
            echo '    fi' >> install_fix.sh
            echo 'done' >> install_fix.sh
            
            echo 'echo \"=== 完成！请测试 import tkinter ===\"' >> install_fix.sh
            
            chmod +x install_fix.sh
            
            echo '正在打包...'
            cd /work
            tar -czvf fix-font-packages-arm64-v2.tar.gz offline_pkgs/
            ls -lh fix-font-packages-arm64-v2.tar.gz
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fix-font-packages-arm64-v2
          path: fix-font-packages-arm64-v2.tar.gz
