name: Download Fix-Font Packages (Smart Dependency)

on: workflow_dispatch

jobs:
  download-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Download Packages via Docker
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          condaforge/miniforge3:latest /bin/bash -c "
            
            # 遇到错误继续执行(为了方便调试输出)，但关键步骤即使失败也要看到日志
            set -x 
            
            echo '=== [1/5] 初始化环境 ==='
            mkdir -p /work/offline_pkgs
            export CONDA_PKGS_DIRS=/work/offline_pkgs
            
            # 强制清理缓存，防止 QEMU 网络导致的 repodata 损坏
            conda clean --all --yes
            
            conda config --add channels conda-forge
            conda config --set channel_priority strict
            
            echo '=== [2/5] 更新索引 (Debug) ==='
            # 先尝试搜索一下 tk，确保 repo data 下载成功
            # 如果这一步失败，说明网络通达性有问题
            conda search 'tk>=8.6' --info | head -n 20
            
            echo '=== [3/5] 下载包 (利用依赖链) ==='
            # 策略：
            # 1. 不指定 tcl，只指定 tk=8.6.*。
            # 2. Conda 解析 tk 依赖时，会自动把 tcl (通常是 8.6.13) 加入下载列表。
            # 3. 加上 --no-deps 是错误的，我们要 deps！所以去掉 --no-deps (默认就是有 deps)
            
            conda create -n download_env \
                python=3.11 \
                'tk=8.6.*' \
                xorg-libxft \
                cairo \
                pango \
                pyinstaller \
                --download-only \
                --yes
            
            echo '=== [4/5] 验证下载内容 ==='
            ls -lh /work/offline_pkgs/
            
            # 检查是否有 tcl 包
            if ls /work/offline_pkgs/tcl-*.conda 1> /dev/null 2>&1 || ls /work/offline_pkgs/tcl-*.tar.bz2 1> /dev/null 2>&1; then
                echo '✅ 成功：Tcl 已被自动下载！'
            else
                echo '❌ 失败：依然没有 Tcl 包，正在强制尝试单独下载...'
                # 最后的保底：如果依赖解析没拉下来，直接用 URL 下载最新的 ARM64 TCL
                # 这是 Conda-forge 目前的固定地址 (8.6.13)
                wget -P /work/offline_pkgs https://conda.anaconda.org/conda-forge/linux-aarch64/tcl-8.6.13-h76f30a9_0.conda
            fi

            echo '=== [5/5] 生成安装脚本并打包 ==='
            cd /work/offline_pkgs
            rm -rf *.lock urls.txt *.json info/
            
            echo '#!/bin/bash' > install_fix.sh
            echo 'set -e' >> install_fix.sh
            echo 'echo \"=== 离线安装 (Smart Mode) ===\"' >> install_fix.sh
            
            # 1. 安装 Tcl (通配符匹配)
            echo 'echo \"-> 安装 Tcl...\"' >> install_fix.sh
            echo 'find . -maxdepth 1 -name \"tcl-*\" | head -n 1 | xargs -I {} conda install --offline --no-deps --force-reinstall {}' >> install_fix.sh
            
            # 2. 安装 Tk
            echo 'echo \"-> 安装 Tk...\"' >> install_fix.sh
            echo 'find . -maxdepth 1 -name \"tk-*\" | grep -v \"noxft\" | head -n 1 | xargs -I {} conda install --offline --no-deps --force-reinstall {}' >> install_fix.sh
            
            # 3. 批量安装其他
            echo 'echo \"-> 安装剩余依赖...\"' >> install_fix.sh
            echo 'for pkg in *.conda *.tar.bz2; do' >> install_fix.sh
            echo '    if [[ \"\$pkg\" != tk-* ]] && [[ \"\$pkg\" != tcl-* ]]; then' >> install_fix.sh
            echo '        echo \"Installing \$pkg ...\"' >> install_fix.sh
            echo '        conda install --offline \"\$pkg\" || echo \"Warning: \$pkg failed\"' >> install_fix.sh
            echo '    fi' >> install_fix.sh
            echo 'done' >> install_fix.sh
            
            chmod +x install_fix.sh
            
            cd /work
            tar -czvf fix-font-pkgs-auto.tar.gz offline_pkgs/
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fix-font-pkgs-auto
          path: fix-font-pkgs-auto.tar.gz
