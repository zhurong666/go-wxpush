name: Download Fix-Font Packages (ARM64)

on: workflow_dispatch

jobs:
  download-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Download Packages via Docker
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          condaforge/miniforge3:latest /bin/bash -c "
            
            set -e
            
            echo '=== [1/4] 准备下载目录 ==='
            mkdir -p /work/offline_pkgs
            
            # 强制指定包缓存路径
            export CONDA_PKGS_DIRS=/work/offline_pkgs
            
            echo '=== [2/4] 配置下载环境 ==='
            conda config --add channels conda-forge
            conda config --set channel_priority strict
            
            echo '=== [3/4] 开始下载 ==='
            # 修正策略：
            # 1. 移除 tcl 显式约束，让 tk 自动拉取 ABI 匹配的 tcl 版本
            # 2. 保留 tk=8.6.* 确保大版本正确
            # 3. 请根据内网实际情况修改 python 版本 (如 python=3.11)
            
            conda create -n temp_env \
                python=3.9 \
                tk=8.6.* \
                pyinstaller \
                --download-only \
                --yes
            
            echo '=== [4/4] 清理与整理 ==='
            cd /work/offline_pkgs
            
            # 清理非包文件
            rm -rf *.lock urls.txt *.json info/
            
            # 生成增强版安装脚本
            cat > install_fix.sh <<EOF
            #!/bin/bash
            echo '=== 开始离线修复 ==='
            
            # 1. 优先强制安装 tk 和 tcl
            # 修正：使用 tk-* 和 tcl-* 通配符，同时支持 .tar.bz2 和 .conda 格式
            echo '-> 安装 Tk/Tcl (强制覆盖)...'
            # 注意：这里利用 shell 扩展，如果没有对应文件会报错，但下载步骤保证了文件存在
            find . -maxdepth 1 -name \"tk-*\" -o -name \"tcl-*\" | xargs -I {} conda install --offline --no-deps --force-reinstall {}
            
            # 2. 安装剩余依赖
            echo '-> 安装其他依赖...'
            # 遍历当前目录下的所有包文件
            for pkg in *; do
                # 简单的后缀检查，确保是 conda 包文件
                if [[ \"\$pkg\" == *.tar.bz2 ]] || [[ \"\$pkg\" == *.conda ]]; then
                    # 排除掉刚才已经装过的 tk 和 tcl，避免重复打印日志
                    if [[ \"\$pkg\" != tk-* ]] && [[ \"\$pkg\" != tcl-* ]]; then
                        echo \"Installing \$pkg ...\"
                        conda install --offline \"\$pkg\"
                    fi
                fi
            done
            
            echo '=== 完成！请测试 import tkinter ==='
            EOF
            chmod +x install_fix.sh
            
            echo '正在打包...'
            cd /work
            tar -czvf fix-font-packages-arm64.tar.gz offline_pkgs/
            ls -lh fix-font-packages-arm64.tar.gz
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fix-font-packages-arm64
          path: fix-font-packages-arm64.tar.gz
