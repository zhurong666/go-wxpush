name: Download Fix-Font Packages (Final Catch-All)

on: workflow_dispatch

jobs:
  download-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 生成脚本：增加了 ls -R 调试，并放宽了 find 匹配模式
      - name: Generate Build Script
        run: |
          cat << 'EOF' > entrypoint.sh
          #!/bin/bash
          set -e
          
          echo "=== [1] 初始化环境 ==="
          conda install -n base binutils curl xz --yes > /dev/null 2>&1
          
          mkdir -p /work/offline_pkgs
          export CONDA_PKGS_DIRS=/work/offline_pkgs
          conda clean --all --yes
          conda config --add channels conda-forge
          conda config --set channel_priority strict
          
          echo "=== [2] 下载常规 Conda 包 ==="
          conda create -n download_env \
              python=3.11 \
              tk=8.6 \
              xorg-libxft cairo pango \
              --download-only --yes
          
          echo "=== [3] 下载并提取 Ubuntu 系统级库 ==="
          mkdir -p /work/system_libs
          cd /work/system_libs
          
          echo "-> Downloading debs..."
          # Ubuntu 18.04 (Bionic) 源
          curl -L -o libtk8.6.deb http://ports.ubuntu.com/pool/main/t/tk8.6/libtk8.6_8.6.8-4_arm64.deb
          curl -L -o libtcl8.6.deb http://ports.ubuntu.com/pool/main/t/tcl8.6/libtcl8.6_8.6.8+dfsg-3_arm64.deb
          
          echo "-> Extracting Tk..."
          ar x libtk8.6.deb data.tar.xz
          tar -xf data.tar.xz
          
          echo "[Debug] 列出解压后的所有 Tk 文件，防止找不到:"
          find . -name "libtk*" -ls
          
          # ★核心修复：查找所有以 libtk8.6.so 开头的实体文件(type f)，不再限制具体版本号
          REAL_TK=$(find . -type f -name "libtk8.6.so*" | head -n 1)
          
          if [ -z "$REAL_TK" ]; then
            echo "❌ Error: 找不到 Tk 实体文件！"
            exit 1
          fi
          
          echo "✅ Found Real Tk Binary: $REAL_TK"
          cp "$REAL_TK" ./libtk8.6.so
          rm data.tar.xz
          rm -rf usr
          
          echo "-> Extracting Tcl..."
          ar x libtcl8.6.deb data.tar.xz
          tar -xf data.tar.xz
          
          # 同理修复 Tcl
          REAL_TCL=$(find . -type f -name "libtcl8.6.so*" | head -n 1)
          echo "✅ Found Real Tcl Binary: $REAL_TCL"
          cp "$REAL_TCL" ./libtcl8.6.so
          rm data.tar.xz
          rm -rf usr
          
          echo "-> 最终验证 (必须 > 1MB):"
          ls -lh *.so
          
          echo "=== [4] 生成安装脚本 ==="
          cd /work
          rm -rf *.lock urls.txt *.json info/
          
          cat > install.sh << 'INSTALL_EOF'
          #!/bin/bash
          echo "=== 1. 安装 Conda 包 ==="
          conda install --offline --no-deps --force-reinstall offline_pkgs/*.conda offline_pkgs/*.tar.bz2
          
          echo "=== 2. 器官移植 (使用 Ubuntu 实体库) ==="
          TARGET_LIB="$CONDA_PREFIX/lib"
          
          echo "正在覆盖 libtk8.6.so ..."
          cp -f system_libs/libtk8.6.so "$TARGET_LIB/libtk8.6.so"
          cp -f system_libs/libtcl8.6.so "$TARGET_LIB/libtcl8.6.so"
          
          # 重建软链接
          ln -sf "$TARGET_LIB/libtk8.6.so" "$TARGET_LIB/libtk8.6.so.0"
          ln -sf "$TARGET_LIB/libtcl8.6.so" "$TARGET_LIB/libtcl8.6.so.0"
          
          echo "=== 3. 注入字体配置 ==="
          mkdir -p "$CONDA_PREFIX/etc/conda/activate.d"
          mkdir -p "$CONDA_PREFIX/etc/conda/deactivate.d"
          
          echo 'export FONTCONFIG_PATH=/etc/fonts' > "$CONDA_PREFIX/etc/conda/activate.d/fonts.sh"
          echo 'unset FONTCONFIG_PATH' >> "$CONDA_PREFIX/etc/conda/deactivate.d/fonts.sh"
          
          echo "✅ 安装完成! 请运行: conda deactivate && conda activate dev"
          INSTALL_EOF
          
          chmod +x install.sh
          
          echo "=== [5] 打包 ==="
          tar -czvf fix-font-final-arm64.tar.gz offline_pkgs/ system_libs/ install.sh
          EOF
          
          chmod +x entrypoint.sh

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Run Docker
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          condaforge/miniforge3:latest /bin/bash /work/entrypoint.sh
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fix-font-final-arm64
          path: fix-font-final-arm64.tar.gz