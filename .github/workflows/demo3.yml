name: Build SSR ARM64 (Portable Brute-Force)

on: workflow_dispatch

jobs:
  build-tarball:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Package
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:20.04 /bin/bash -c "
            
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo '>>> [1/6] 安装依赖...'
            apt-get update
            apt-get install -y build-essential cmake git wget file grep findutils sed \
                qt5-default qttools5-dev-tools qttools5-dev libqt5x11extras5-dev \
                libavformat-dev libavcodec-dev libavutil-dev libswscale-dev \
                libasound2-dev libpulse-dev libjack-dev \
                libx11-dev libxext-dev libxfixes-dev libxi-dev libxinerama-dev \
                libgl1-mesa-dev libglu1-mesa-dev \
                libv4l-dev \
                squashfs-tools

            echo '>>> [2/6] 编译 SimpleScreenRecorder...'
            cd /work
            rm -rf ssr
            git clone https://github.com/MaartenBaert/ssr.git
            cd ssr
            mkdir build && cd build
            
            cmake .. \
                -DCMAKE_INSTALL_PREFIX=/AppDir/usr \
                -DCMAKE_BUILD_TYPE=Release \
                -DWITH_GLINJECT=OFF \
                -DWITH_PIPEWIRE=OFF \
                -DWITH_QT5=ON
            
            make -j\$(nproc)
            make install
            
            echo '>>> [3/6] 准备打包工具...'
            cd /work
            wget -c https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
            wget -c https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-aarch64.AppImage
            chmod +x linuxdeploy*.AppImage
            
            # 使用官方解压参数，更稳定
            ./linuxdeploy-aarch64.AppImage --appimage-extract
            mv squashfs-root linuxdeploy-root
            
            ./linuxdeploy-plugin-qt-aarch64.AppImage --appimage-extract
            mv squashfs-root linuxdeploy-qt-plugin
            
            # 安装二进制文件到 /usr/bin (注意路径变化)
            cp linuxdeploy-root/usr/bin/linuxdeploy /usr/bin/linuxdeploy
            cp linuxdeploy-qt-plugin/usr/bin/linuxdeploy-plugin-qt /usr/bin/linuxdeploy-plugin-qt
            chmod +x /usr/bin/linuxdeploy /usr/bin/linuxdeploy-plugin-qt
            
            # 验证插件存在
            ls -l /usr/bin/linuxdeploy*
            
            echo '>>> [4/6] 暴力打包 (缺什么补什么)...'
            export QMAKE=/usr/bin/qmake
            export QT_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/qt5/plugins/
            export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib
            
            # 1. 寻找或伪造 Desktop 文件
            DESKTOP_FILE=\$(find /AppDir -name \"*.desktop\" | head -n 1)
            
            if [ -z \"\$DESKTOP_FILE\" ]; then
                echo \"⚠️ 没找到 Desktop 文件，正在手写一个...\"
                mkdir -p /AppDir/usr/share/applications
                DESKTOP_FILE=\"/AppDir/usr/share/applications/ssr.desktop\"
                
                echo \"[Desktop Entry]\" > \$DESKTOP_FILE
                echo \"Type=Application\" >> \$DESKTOP_FILE
                echo \"Name=SimpleScreenRecorder\" >> \$DESKTOP_FILE
                echo \"Exec=simplescreenrecorder\" >> \$DESKTOP_FILE
                echo \"Icon=simplescreenrecorder\" >> \$DESKTOP_FILE
                echo \"Categories=AudioVideo;Recorder;\" >> \$DESKTOP_FILE
            fi
            
            # 2. 寻找或随便抓一个 Icon 文件
            ICON_FILE=\$(find /AppDir -name \"*.png\" | head -n 1)
            
            if [ -z \"\$ICON_FILE\" ]; then
                 echo \"⚠️ 连图标都没找到？生成一个空的图片文件...\"
                 touch /AppDir/dummy_icon.png
                 ICON_FILE=\"/AppDir/dummy_icon.png\"
            fi
            
            echo \"DEBUG: Using Desktop: \$DESKTOP_FILE\"
            echo \"DEBUG: Using Icon: \$ICON_FILE\"

            # 运行打包
            linuxdeploy \
              --appdir=\"/AppDir\" \
              --desktop-file=\"\$DESKTOP_FILE\" \
              --icon-file=\"\$ICON_FILE\" \
              --plugin=qt
            
            echo '>>> [5/6] 注入运行库 & 启动脚本...'
            cp /usr/lib/aarch64-linux-gnu/libstdc++.so.6 /AppDir/usr/lib/
            cp /lib/aarch64-linux-gnu/libgcc_s.so.1 /AppDir/usr/lib/

            rm -f /AppDir/AppRun
            touch /AppDir/AppRun
            echo '#!/bin/bash' >> /AppDir/AppRun
            echo 'SELF=\$(readlink -f \"\$0\")' >> /AppDir/AppRun
            echo 'HERE=\${SELF%/*}' >> /AppDir/AppRun
            echo 'export LD_LIBRARY_PATH=\${HERE}/usr/lib:\$LD_LIBRARY_PATH' >> /AppDir/AppRun
            echo 'export QT_PLUGIN_PATH=\${HERE}/usr/plugins' >> /AppDir/AppRun
            echo 'exec \${HERE}/usr/bin/simplescreenrecorder \"\$@\"' >> /AppDir/AppRun
            chmod +x /AppDir/AppRun
            
            echo '>>> [6/6] 压缩...'
            mv /AppDir SSR-ARM64-Portable
            tar -czvf SSR-ARM64-Portable.tar.gz SSR-ARM64-Portable/
            
            ls -lh SSR-ARM64-Portable.tar.gz
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SSR-ARM64-Portable
          path: SSR-ARM64-Portable.tar.gz
