name: Build SSR ARM64 (Portable Fixed v6)

on: workflow_dispatch

jobs:
  build-tarball:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Package
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:20.04 /bin/bash -c "
            
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo '>>> [1/6] å®‰è£…ä¾èµ–...'
            apt-get update
            apt-get install -y build-essential cmake git wget file grep findutils sed \
                qt5-default qttools5-dev-tools qttools5-dev libqt5x11extras5-dev \
                libavformat-dev libavcodec-dev libavutil-dev libswscale-dev \
                libasound2-dev libpulse-dev libjack-dev \
                libx11-dev libxext-dev libxfixes-dev libxi-dev libxinerama-dev \
                libgl1-mesa-dev libglu1-mesa-dev \
                libv4l-dev \
                squashfs-tools

            echo '>>> [2/6] ç¼–è¯‘ SimpleScreenRecorder...'
            cd /work
            rm -rf ssr
            git clone https://github.com/MaartenBaert/ssr.git
            cd ssr
            mkdir build && cd build
            
            cmake .. \
                -DCMAKE_INSTALL_PREFIX=/AppDir/usr \
                -DCMAKE_BUILD_TYPE=Release \
                -DWITH_GLINJECT=OFF \
                -DWITH_PIPEWIRE=OFF \
                -DWITH_QT5=ON
            
            make -j\$(nproc)
            make install
            
            echo '>>> [3/6] å‡†å¤‡æ‰“åŒ…å·¥å…·...'
            cd /work
            wget -c https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
            wget -c https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-aarch64.AppImage
            chmod +x linuxdeploy*.AppImage
            
            # === æ‰‹åŠ¨è§£åŽ‹ (å¤–ç§‘æ‰‹æœ¯å¼) ===
            echo 'Extracting LinuxDeploy...'
            OFFSET=\$(grep -aob \"hsqs\" linuxdeploy-aarch64.AppImage | head -n 1 | cut -d: -f1)
            unsquashfs -o \$OFFSET -d linuxdeploy-root linuxdeploy-aarch64.AppImage
            
            echo 'Extracting Qt Plugin...'
            OFFSET=\$(grep -aob \"hsqs\" linuxdeploy-plugin-qt-aarch64.AppImage | head -n 1 | cut -d: -f1)
            unsquashfs -o \$OFFSET -d linuxdeploy-qt-plugin linuxdeploy-plugin-qt-aarch64.AppImage
            
            # === ðŸ”¥ å…³é”®ä¿®å¤ï¼šå®‰è£…æ’ä»¶å¹¶åˆ é™¤ AppImage æºæ–‡ä»¶ ===
            # æŠŠæ’ä»¶ç§»åˆ°ç³»ç»Ÿè·¯å¾„
            mv linuxdeploy-qt-plugin/AppRun /usr/bin/linuxdeploy-plugin-qt
            
            # ðŸ’€ æ¯å°¸ç­è¿¹ï¼šåˆ é™¤ .AppImage æ–‡ä»¶ï¼Œé˜²æ­¢ linuxdeploy ä¼˜å…ˆè°ƒç”¨å®ƒä»¬å¯¼è‡´ QEMU å´©æºƒ
            rm -f /work/*.AppImage
            
            echo '>>> [4/6] æ™ºèƒ½æ‰“åŒ…...'
            export QT_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/qt5/plugins/
            export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib
            
            # ðŸ”¥ ä¿®å¤ï¼šæ›´æ™ºèƒ½çš„æŸ¥æ‰¾é€»è¾‘ (æ”¯æŒ svg å’Œ pngï¼Œä¸é™ç›®å½•)
            # æŸ¥æ‰¾ä»¥ simplescreenrecorder å¼€å¤´çš„ desktop æ–‡ä»¶
            DESKTOP_FILE=\$(find /AppDir -name \"simplescreenrecorder.desktop\" | head -n 1)
            
            # æŸ¥æ‰¾å›¾æ ‡ï¼šåªè¦æ–‡ä»¶ååŒ…å« simple ä¸”æ˜¯å›¾ç‰‡ï¼Œå°±æ‹¿ç¬¬ä¸€ä¸ªã€‚SSR é»˜è®¤é€šå¸¸æ˜¯ .svg
            ICON_FILE=\$(find /AppDir -path \"*icons*\" \( -name \"*.svg\" -o -name \"*.png\" \) | head -n 1)
            
            echo \"DEBUG: Desktop file found: '\$DESKTOP_FILE'\"
            echo \"DEBUG: Icon file found: '\$ICON_FILE'\"
            
            # åŒé‡ä¿é™©ï¼šå¦‚æžœæ²¡æ‰¾åˆ°ï¼Œå°±æŠ¥é”™åœæ­¢ï¼Œé˜²æ­¢çžŽæ‰“åŒ…
            if [ -z \"\$DESKTOP_FILE\" ] || [ -z \"\$ICON_FILE\" ]; then
                echo \"âŒ é”™è¯¯: ç¼ºå°‘ Desktop æ–‡ä»¶æˆ–å›¾æ ‡æ–‡ä»¶ï¼\"
                exit 1
            fi

            # è¿è¡Œæ‰“åŒ… (ä½¿ç”¨æå–å‡ºçš„ linuxdeploy)
            ./linuxdeploy-root/AppRun \
              --appdir=\"/AppDir\" \
              --desktop-file=\"\$DESKTOP_FILE\" \
              --icon-file=\"\$ICON_FILE\" \
              --plugin=qt
            
            echo '>>> [5/6] æ³¨å…¥è¿è¡Œåº“ & å¯åŠ¨è„šæœ¬...'
            cp /usr/lib/aarch64-linux-gnu/libstdc++.so.6 /AppDir/usr/lib/
            cp /lib/aarch64-linux-gnu/libgcc_s.so.1 /AppDir/usr/lib/

            rm -f /AppDir/AppRun
            touch /AppDir/AppRun
            echo '#!/bin/bash' >> /AppDir/AppRun
            echo 'SELF=\$(readlink -f \"\$0\")' >> /AppDir/AppRun
            echo 'HERE=\${SELF%/*}' >> /AppDir/AppRun
            echo 'export LD_LIBRARY_PATH=\${HERE}/usr/lib:\$LD_LIBRARY_PATH' >> /AppDir/AppRun
            echo 'export QT_PLUGIN_PATH=\${HERE}/usr/plugins' >> /AppDir/AppRun
            echo 'exec \${HERE}/usr/bin/simplescreenrecorder \"\$@\"' >> /AppDir/AppRun
            chmod +x /AppDir/AppRun
            
            echo '>>> [6/6] åŽ‹ç¼©...'
            mv /AppDir SSR-ARM64-Portable
            tar -czvf SSR-ARM64-Portable.tar.gz SSR-ARM64-Portable/
            
            ls -lh SSR-ARM64-Portable.tar.gz
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SSR-ARM64-Portable
          path: SSR-ARM64-Portable.tar.gz
      
