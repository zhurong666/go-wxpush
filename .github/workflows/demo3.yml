name: Build SSR ARM64 (Safe Echo)

on: workflow_dispatch

jobs:
  build-tarball:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Package
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:20.04 /bin/bash -c "
            
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo '=== [1/6] 安装依赖 ==='
            apt-get update
            apt-get install -y build-essential cmake git wget file grep findutils sed \
                qt5-default qttools5-dev-tools qttools5-dev libqt5x11extras5-dev \
                libavformat-dev libavcodec-dev libavutil-dev libswscale-dev \
                libasound2-dev libpulse-dev libjack-dev \
                libx11-dev libxext-dev libxfixes-dev libxi-dev libxinerama-dev \
                libgl1-mesa-dev libglu1-mesa-dev \
                libv4l-dev \
                squashfs-tools

            echo '=== [2/6] 编译 SSR ==='
            cd /work
            rm -rf ssr
            git clone https://github.com/MaartenBaert/ssr.git
            cd ssr
            mkdir build && cd build
            
            cmake .. \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DCMAKE_BUILD_TYPE=Release \
                -DWITH_GLINJECT=OFF \
                -DWITH_PIPEWIRE=OFF \
                -DWITH_QT5=ON
            
            make -j\$(nproc)
            make install DESTDIR=/AppDir
            
            echo '=== [3/6] 准备打包工具 ==='
            cd /work
            wget -nv https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
            chmod +x linuxdeploy-aarch64.AppImage
            
            # 使用 unsquashfs 强制解压
            OFFSET=\$(grep -aob \"hsqs\" linuxdeploy-aarch64.AppImage | head -n 1 | cut -d: -f1)
            unsquashfs -o \$OFFSET -d linuxdeploy-root linuxdeploy-aarch64.AppImage
            chmod +x linuxdeploy-root/AppRun

            echo '=== [4/6] 智能处理资源文件 ==='
            
            # --- 1. 处理 Desktop 文件 (改用 echo 防止 EOF 错误) ---
            DESKTOP_FILE=\$(find /AppDir -name \"*.desktop\" | head -n 1)
            
            if [ -z \"\$DESKTOP_FILE\" ]; then
                echo \"⚠️ 生成默认 Desktop 文件...\"
                mkdir -p /AppDir/usr/share/applications
                DESKTOP_FILE=\"/AppDir/usr/share/applications/ssr.desktop\"
                
                echo '[Desktop Entry]' > \$DESKTOP_FILE
                echo 'Type=Application' >> \$DESKTOP_FILE
                echo 'Name=SimpleScreenRecorder' >> \$DESKTOP_FILE
                echo 'GenericName=Screen Recorder' >> \$DESKTOP_FILE
                echo 'Comment=A feature-rich screen recorder' >> \$DESKTOP_FILE
                echo 'Keywords=screen;recorder;capture;grab;' >> \$DESKTOP_FILE
                echo 'Exec=simplescreenrecorder' >> \$DESKTOP_FILE
                echo 'Icon=simplescreenrecorder' >> \$DESKTOP_FILE
                echo 'Terminal=false' >> \$DESKTOP_FILE
                echo 'Categories=AudioVideo;Video;Recorder;Qt;' >> \$DESKTOP_FILE
            fi
            echo \"✅ 使用 Desktop 文件: \$DESKTOP_FILE\"

            # --- 2. 处理图标文件 ---
            ICON_FILE=\$(find /AppDir -name \"simplescreenrecorder.svg\" -o -name \"simplescreenrecorder.png\" | head -n 1)
            
            if [ -z \"\$ICON_FILE\" ]; then
                echo \"⚠️ 尝试从源码提取图标...\"
                ICON_FILE=\$(find /work/ssr -name \"icon.svg\" -o -name \"simplescreenrecorder.svg\" | head -n 1)
            fi
            
            if [ -z \"\$ICON_FILE\" ]; then
                echo \"⚠️ 在线下载图标...\"
                wget -O /tmp/ssr_icon.svg https://raw.githubusercontent.com/MaartenBaert/ssr/master/data/resources/icon.svg
                ICON_FILE=\"/tmp/ssr_icon.svg\"
            fi
            echo \"✅ 使用图标文件: \$ICON_FILE\"

            # --- 3. 运行 LinuxDeploy 归档 ---
            ./linuxdeploy-root/AppRun \
              --appdir /AppDir \
              --desktop-file \"\$DESKTOP_FILE\" \
              --icon-file \"\$ICON_FILE\" \
              --executable /AppDir/usr/bin/simplescreenrecorder
            
            echo '=== [5/6] 注入依赖库 ==='
            mkdir -p /AppDir/usr/plugins
            cp -r /usr/lib/aarch64-linux-gnu/qt5/plugins/* /AppDir/usr/plugins/
            
            mkdir -p /AppDir/usr/lib
            
            # 定义依赖抓取函数
            copy_deps() {
                local binary=\$1
                deps=\$(ldd \"\$binary\" | grep \"=> /\" | awk '{print \$3}' | grep -vE \"ld-linux|vdso\")
                for lib in \$deps; do
                    libname=\$(basename \"\$lib\")
                    if [ ! -f \"/AppDir/usr/lib/\$libname\" ]; then
                        cp \"\$lib\" \"/AppDir/usr/lib/\"
                    fi
                done
            }
            
            copy_deps /AppDir/usr/bin/simplescreenrecorder
            
            find /AppDir/usr/plugins -name \"*.so\" | while read plugin; do
                copy_deps \"\$plugin\"
            done
            
            cp /usr/lib/aarch64-linux-gnu/libstdc++.so.6 /AppDir/usr/lib/
            cp /lib/aarch64-linux-gnu/libgcc_s.so.1 /AppDir/usr/lib/

            echo '=== [6/6] 打包 ==='
            rm -f /AppDir/AppRun
            
            # --- 生成启动脚本 (改用 echo 防止 EOF 错误) ---
            touch /AppDir/AppRun
            echo '#!/bin/bash' > /AppDir/AppRun
            echo 'SELF=$(readlink -f "$0")' >> /AppDir/AppRun
            echo 'HERE=${SELF%/*}' >> /AppDir/AppRun
            echo 'export LD_LIBRARY_PATH="${HERE}/usr/lib:$LD_LIBRARY_PATH"' >> /AppDir/AppRun
            echo 'export QT_PLUGIN_PATH="${HERE}/usr/plugins"' >> /AppDir/AppRun
            echo 'export QT_QPA_PLATFORM_PLUGIN_PATH="${HERE}/usr/plugins/platforms"' >> /AppDir/AppRun
            echo 'exec "${HERE}/usr/bin/simplescreenrecorder" "$@"' >> /AppDir/AppRun
            
            chmod +x /AppDir/AppRun
            
            mv /AppDir SSR-ARM64-Portable
            tar -czvf SSR-ARM64-Portable.tar.gz SSR-ARM64-Portable/
            
            ls -lh SSR-ARM64-Portable.tar.gz
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SSR-ARM64-Portable
          path: SSR-ARM64-Portable.tar.gz
