name: Build Ksnip ARM64 (Victory Edition)

on: workflow_dispatch

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build and Pack
        run: |
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          ubuntu:22.04 /bin/bash -c "
            
            # 遇到错误直接退出
            set -e  
            export DEBIAN_FRONTEND=noninteractive
            export INSTALL_PREFIX=/usr
            
            echo '=== [1/7] 安装全套环境 ==='
            apt-get update
            # 必须包含 grep 以便计算偏移量
            apt-get install -y build-essential cmake git wget file grep \
                qtbase5-dev libqt5svg5-dev libqt5x11extras5-dev \
                libxcb-xinerama0-dev libxcb-shape0-dev libxcb-xfixes0-dev \
                libx11-dev zlib1g-dev \
                qttools5-dev qttools5-dev-tools \
                extra-cmake-modules \
                squashfs-tools

            mkdir -p /tmp/build_src
            cd /tmp/build_src

            echo '=== [2/7] 编译 kColorPicker ==='
            git clone https://github.com/ksnip/kColorPicker.git
            cd kColorPicker
            mkdir build && cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=\$INSTALL_PREFIX -DBUILD_SHARED_LIBS=ON \
                     -DBUILD_TESTS=OFF -DBUILD_EXAMPLES=OFF
            make -j2
            make install
            cd ../..

            echo '=== [3/7] 编译 kImageAnnotator ==='
            git clone https://github.com/ksnip/kImageAnnotator.git
            cd kImageAnnotator
            mkdir build && cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=\$INSTALL_PREFIX -DBUILD_SHARED_LIBS=ON \
                     -DBUILD_TESTS=OFF -DBUILD_EXAMPLES=OFF
            make -j2
            make install
            cd ../..

            echo '=== [4/7] 编译 Ksnip ==='
            git clone https://github.com/ksnip/ksnip.git
            cd ksnip
            mkdir build && cd build
            cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/AppDir/usr
            make -j2
            make install
            
            echo '=== [5/7] 暴力拆解打包工具 (Offset Hack) ==='
            cd /work
            wget -nv https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
            chmod +x linuxdeploy-aarch64.AppImage
            
            # 【核心修复】自动计算 SquashFS 的偏移量
            # AppImage = ELF Header + SquashFS Data
            # 我们通过查找 'hsqs' (SquashFS 的魔术签名) 来定位起始位置
            OFFSET=\$(grep -aob \"hsqs\" linuxdeploy-aarch64.AppImage | head -n 1 | cut -d: -f1)
            
            echo \"检测到 SquashFS 偏移量: \$OFFSET\"
            
            # 使用 -o 参数指定偏移量进行解压
            unsquashfs -o \$OFFSET -d linuxdeploy-root linuxdeploy-aarch64.AppImage
            
            echo '=== [6/7] 生成最终 AppImage ==='
            export QT_PLUGIN_PATH=/usr/lib/aarch64-linux-gnu/qt5/plugins/
            export LD_LIBRARY_PATH=/usr/lib:/usr/local/lib
            
            # 直接调用解压出来的二进制文件，绕过所有 AppImage 启动器的问题
            ./linuxdeploy-root/usr/bin/linuxdeploy \
              --appdir /AppDir \
              --desktop-file /AppDir/usr/share/applications/org.ksnip.ksnip.desktop \
              --icon-file /AppDir/usr/share/icons/hicolor/scalable/apps/org.ksnip.ksnip.svg \
              --output appimage

            echo '=== [7/7] 大功告成 ==='
            mv *.AppImage ksnip-arm64.AppImage
            chmod 777 ksnip-arm64.AppImage
            ls -lh ksnip-arm64.AppImage
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ksnip-arm64-stable
          path: ksnip-arm64.AppImage
