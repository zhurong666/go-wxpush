name: Build Mitmproxy ARM64 (Fixed)

on: workflow_dispatch

jobs:
  build-arm64-fixed:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      - name: Build in Docker (Python 3.11 Base)
        run: |
          # ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šç›´æ¥ä½¿ç”¨ Python 3.11 çš„å®˜æ–¹é•œåƒï¼Œä¸å†æ‰‹åŠ¨å®‰è£…
          docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/work \
          python:3.11-bullseye /bin/bash -c "
            
            set -e
            export DEBIAN_FRONTEND=noninteractive
            
            echo '>>> [1/4] å®‰è£…ç¼–è¯‘å·¥å…· (GCC, CMake, Rust)...'
            apt-get update
            # å®‰è£…æ„å»ºä¾èµ– (Rust éœ€è¦ç”¨äºæ„å»º cryptography ç­‰åº“)
            apt-get install -y build-essential cmake git libffi-dev libssl-dev zlib1g-dev curl
            
            # å®‰è£… Rust (mitmproxy ä¾èµ–çš„æŸäº›åº“å¿…é¡»ç”¨ Rust ç¼–è¯‘)
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source \$HOME/.cargo/env
            
            echo '>>> [2/4] å‡†å¤‡ Python ç¯å¢ƒ...'
            # Python 3.11 å·²ç»å†…ç½®äº†ï¼Œç›´æ¥å‡çº§ pip
            pip install --upgrade pip wheel pyinstaller
            
            mkdir -p /work/output/mitmproxy-wheels
            
            echo '>>> [3/4] ä¸‹è½½ç¦»çº¿ä¾èµ–åŒ… (Wheel)...'
            # ä¸‹è½½ mitmproxy åŠå…¶æ‰€æœ‰ä¾èµ–çš„ .whl æ–‡ä»¶
            # è¿™ä¸€æ­¥ä¼šè°ƒç”¨ GCC/Rust ç°åœºç¼–è¯‘é‚£äº›æ²¡æœ‰ç°æˆ ARM64 åŒ…çš„åº“
            pip download mitmproxy==10.4.2 --dest /work/output/mitmproxy-wheels
            
            echo '>>> [4/4] ç¼–è¯‘å•æ–‡ä»¶ mitmdump (å¯é€‰å¤‡ç”¨)...'
            # è¿™æ˜¯ä¸€ä¸ªåŒä¿é™©ï¼šå¦‚æœ wheel å®‰è£…å¤±è´¥ï¼Œå¯ä»¥ç›´æ¥ç”¨è¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
            pip install mitmproxy==10.4.2
            
            # åˆ›å»ºå…¥å£è„šæœ¬
            echo 'from mitmproxy.tools.dump import mitmdump; mitmdump()' > launch_dump.py
            
            # æ‰“åŒ…æˆå•æ–‡ä»¶ (Stand-alone Binary)
            pyinstaller --clean --onefile --name mitmdump-arm64 launch_dump.py
            
            # æ•´ç†äº§ç‰©
            mv dist/mitmdump-arm64 /work/output/
            cd /work/output
            
            # åˆ›å»ºä¸€é”®å®‰è£…è„šæœ¬
            echo '#!/bin/bash' > install.sh
            echo 'pip install --no-index --find-links=mitmproxy-wheels mitmproxy' >> install.sh
            chmod +x install.sh
            
            # å‹ç¼©æ‰€æœ‰æ–‡ä»¶
            tar -czvf /work/mitmproxy-arm64-kit.tar.gz .
            echo 'âœ… æ„å»ºæˆåŠŸï¼'
          "

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mitmproxy-arm64-kit
          path: mitmproxy-arm64-kit.tar.gz
