name: Pack PyQt5 Environment for UOS

on: [workflow_dispatch]

jobs:
  pack-conda-env:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. 设置 QEMU 模拟 ARM64
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: linux/arm64

      # 2. 在 ARM64 的 Conda 容器中打包
      - name: Build and Pack in Container
        run: |
          # 使用 Miniforge (原生支持 ARM64 + Conda-forge)
          docker run --rm -v ${{ github.workspace }}:/work -w /work condaforge/miniforge3:latest /bin/bash -c "
            
            echo '=== 1. 创建环境 (Python 3.11 + PyQt5) ==='
            # 必须指定 pyqt=5，否则可能会装成 6
            # conda-forge 的二进制包完美支持 ARM64
            conda create -n uos_env python=3.11 pyqt=5.15 -y
            
            echo '=== 2. 安装打包工具 ==='
            conda install -n base -c conda-forge conda-pack -y
            
            echo '=== 3. 打包整个环境 ==='
            # 这会将整个环境打包成一个单文件，解压即用
            conda pack -n uos_env -o pyqt5_uos_arm64.tar.gz
            
            echo '=== 4. 修改权限 ==='
            chmod 777 pyqt5_uos_arm64.tar.gz
          "

      # 3. 上传结果
      - name: Upload Environment
        uses: actions/upload-artifact@v4
        with:
          name: pyqt5-offline-env
          path: pyqt5_uos_arm64.tar.gz
